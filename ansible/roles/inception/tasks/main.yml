---
# --- Mount Persistent Volume ---
- name: Create mount directory
  file:
    path: "{{ data_mount_point }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0755'

- name: Format persistence disk (ext4) if not exists
  filesystem:
    fstype: ext4
    dev: "/dev/disk/by-id/{{ disk_device_id }}"

- name: Mount persistence disk
  mount:
    path: "{{ data_mount_point }}"
    src: "/dev/disk/by-id/{{ disk_device_id }}"
    fstype: ext4
    state: mounted
    opts: defaults

- name: Create data subdirectories
  file:
    path: "{{ data_mount_point }}/{{ item }}"
    state: directory
    owner: "{{ target_user }}"
    group: "{{ target_user }}"
    mode: '0777'
  loop:
    - wordpress
    - mariadb
  
# --- Deploy project files ---
- name: Synchronize inception files
  synchronize:
    src: "{{ project_src }}/"
    dest: "{{ dest_path }}/"
    delete: yes
    recursive: yes
    rsync_opts:
      - "--exclude=.git"
      - "--exclude=data"

# --- Env ---
- name: Update .env data paths for Cloud environment
  lineinfile:
    path: "{{ dest_path }}/.env"
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - { key: 'WP_DATA_PATH', value: "{{ data_mount_point }}/wordpress" }
    - { key: 'DB_DATA_PATH', value: "{{ data_mount_point }}/mariadb" }

# --- Run application ---
- name: Start Inception via Make
  community.general.make:
    chdir: "{{ dest_path }}"
    target: up    
